window.onload=function(){var U={NAME:"ThoomicDB",VERSION:1},A=["cif","name","telefono","email"],ag=$("#domicilio"),F=$("#cp"),ap=$("#poblacion"),r=$("#pais"),b=[],z=[],aa=true,L,T=document.getElementById("form_datos"),v=$("#panel"),t=$("#deleteID"),s=$("#nuevo_cliente"),P=$("#popup_delete"),H=$("#address"),M=$("#deltitulo"),al=$("#panel_titulo"),w=$("#lista"),ai=$("#datapanel"),D=$("#nuevobill"),g=$("#btn_save"),I=document.getElementById("jogo"),am=document.getElementById("txjogo"),R=document.getElementById("myFilter"),aq=$("#form_bill"),n=$("#titulobill"),Q=$("#numerobill"),C=$("#fechabill"),j=$("#concepto"),af=$("#cantidad"),k=$("#precio"),O=$("#status"),q=$("#msg"),e=$("#rotulo"),ao=$("#principal"),B=document.getElementById("texto_concepto"),K=document.getElementById("texto_new"),ad=$("#titulo_nuevo");function ae(ar){if(ar){q.text(ar);O.animate({opacity:"1"});setTimeout(function(){O.animate({opacity:"0"})},3000);window.console.log(ar);if(e){e.text(ar)}}}function E(){var ar=f();R.focus();if(!ar[1]){e.text("Please, enter your data as an invoice issuer.")}else{e.text("Button menu for details: "+ar[1])}}function d(){var au=new Date(),av,ar,at;av=au.getDate();ar=au.getMonth();ar=ar+1;at=au.getFullYear();au=(av+"/"+ar+"/"+at);return au}function X(at){if(at){for(var ar=0;ar<at.elements.length;ar++){at.elements[ar].value="";at.elements[ar].style.background="#FFFFFF"}K.innerHTML=""}}function l(ar){var at=parseInt(localStorage.getItem(ar),10);if(at){at=at+1}else{at=1}localStorage.setItem(ar,at);return at}function y(at,ar){var au;if(at){v.panel("close");X(T);ad.text(ar);for(au in A){if(A.hasOwnProperty(au)){if(at[A[au]]){T.elements[au].value=at[A[au]]}}}s.popup("open",{positionTo:"window",transition:"pop"})}}function W(){var ar;n.text("Invoice to: "+al.text());ar="000000"+l(n.text());Q.text(ar);C.text(d());j.val("");af.val("");k.val("");B.innerHTML="";D.popup();D.popup("open",{positionTo:"window",transition:"pop"})}function i(){X(T);if(al.text()==="Thoomic"){Z();ad.text("New Client");e.text("Add customer data.");s.popup("open",{positionTo:"window",transition:"pop"})}else{e.text("Add Invoice");W()}}function f(){var ar,at={};for(ar in A){if(A.hasOwnProperty(ar)){at[A[ar]]=localStorage.getItem(A[ar])}}return at}function p(){v.panel("close");w.empty();w.removeClass("datos");$("#textologo").empty();$("hori").empty();clearTimeout(L)}function ak(ar){var au,at=$("#textologo");p();if(ar.name){if(al.text()==="Thoomic"){$("<a href='#' class='ui-btn ui-btn-inline ui-icon-grid ui-btn-icon-left ui-mini ui-corner-all color' id='bill'>").append("toBill").appendTo(at);$("#bill").click(function(){u(ar.name)})}else{ar.domicilio=localStorage.getItem("domicilio");ar.cp=localStorage.getItem("cp");ar.poblacion=localStorage.getItem("poblacion");ar.pais=localStorage.getItem("pais")}$("<a href='#' class='ui-btn ui-btn-inline ui-icon-gear ui-btn-icon-left ui-mini ui-corner-all' id='up'>").append((ar.name||"Your company")).appendTo(at);$("<div>").append("<span>&nbsp;&nbsp;&nbsp;"+(ar.cif||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(ar.telefono||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(ar.email||"")+"</span><p>").appendTo(at);$("<div class='margen'>").append("<a href='#' id='loc' data-mini='true' class='ui-btn ui-mini ui-icon-home ui-btn-icon-left ui-btn-inline ui-corner-all'>Location</a>").appendTo(at);$("<div>").append("</span><span>&nbsp;&nbsp;&nbsp;"+(ar.domicilio||"")).appendTo(at);$("<div>").append("</span><span>&nbsp;&nbsp;&nbsp;"+(ar.cp||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(ar.poblacion||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(ar.pais||"")+"</span><p>").appendTo(at);$("#update").text(ar.name);$("#up").click(function(){y(ar)});$("#loc").click(function(){ag.val(ar.domicilio);F.val(ar.cp);ap.val(ar.poblacion);r.val(ar.pais);H.popup("open",{positionTo:"window",transition:"pop"})});$("#logo").show()}else{e.text("Add details of your company.")}}function an(){var ar;w.removeClass("datos");clearTimeout(L);X(T);e.text("Complete your company details.");ad.text("Invoice Issuer");ar=f();al.text(ar.name);ak(ar);if(!ar.name){s.popup("open",{positionTo:"window",transition:"pop"})}al.text("Thoomic")}function ac(){v.panel("close");if(window.File&&window.FileReader&&window.FileList&&window.Blob){$("#readfile").popup("open",{positionTo:"window",transition:"pop"})}else{ae("Error: Not support File Api")}}function m(){v.panel("close");if(z[0]){M.text("Export...")}else{M.text("There is no customer data...")}P.popup("open",{positionTo:"window",transition:"pop"})}function J(){v.panel("close");M.text("Deleting...");P.popup("open",{positionTo:"window",transition:"pop"})}function ah(aw){var ay,ar,at=[],av=document.getElementById("#form_update"),au=$("#tax"),ax=$("#sel");if(typeof aw=="string"&&b.length<1){e.text("There is no data, please add invoices.");$("#textologo").empty();$("#hori").empty();$("<div>").append("<p class='margen' style='color: red;'>There are no invoices in the database, please write them.</p>").appendTo("#textologo");$("#logo").show()}else{$("<li>").append("<a href='#' id="+aw.name+"><h3>"+aw.titulo+"</h3><p>Date: "+aw.fecha+"&nbsp;&nbsp;&nbsp;&nbsp;Bill Nº: "+aw.name+"&nbsp;&nbsp;&nbsp;&nbsp;</p></a>").appendTo(w);n.text(aw.titulo);ay="#"+aw.name;$(ay).click(function(aB){var aC,az,aA;aB.stopPropagation();ai.empty();MYPDF.init();openDB.odb.open(U,aw.titulo,MYPDF.client,"get");for(aC in aw){if(aw.hasOwnProperty(aC)){if(aC!="titulo"){if(aC==="name"){aA="#fac"+aw[aC];$("<li>").append("<a href='#' class='color' id=fac"+aw[aC]+">Nº "+aw[aC]+"</a>").appendTo(ai)}else{if(aC==="fecha"){$("<li class='color'>").append("<span>"+aw[aC]+"</span>").appendTo(ai)}else{for(az in aw[aC]){if(aw[aC].hasOwnProperty(az)&&(az==="concepto")){ar=aw[aC].cantidad*aw[aC].precio;$("<li class='color'>").append("<span class='cantidad'>"+aw[aC].cantidad+"</span><span>&nbsp;"+aw[aC][az]+"</span><span>&nbsp;&nbsp;&nbsp;"+ar+"&#8364;</span>").appendTo(ai);MYPDF.bill(aw[aC].concepto,aw[aC].cantidad,aw[aC].precio)}}}}}}}$("#btn_generating").click(function(aD){var aE=21;if(au.val()){aE=au.val()}localStorage.setItem("tax",aE);MYPDF.save($("#comments").val(),aE,ax.val());$("#genpdf").popup("close")});$(aA).click(function(aD){v.panel("close");MYPDF.name(aw.titulo);MYPDF.date(aw.fecha);MYPDF.fac(aw.name);at=f();if(at[1]){MYPDF.setup(at);$("#comments").val("");mytax=localStorage.getItem("tax");if(mytax>0){au.val(parseInt(mytax))}else{au.val("")}$("#genpdf").popup("open",{positionTo:"window",transition:"pop"})}else{ae("Setup is empty, write it!!")}});t.text(aw.name);ai.listview("refresh");v.panel("open")});w.listview("refresh")}}function u(ar){v.panel("close");w.empty();w.removeClass("datos");if(ar){e.text("Invoice to: "+ar);var at={NAME:ar,VERSION:1};openDB.odb.open(at,null,ah,"read");al.text(ar);i()}}function a(at,ar){at.css("background-color","#ffcc66").trigger("create");at.on("focusin",function(){at.css("background-color","#ffffff").trigger("create")});ar.innerHTML="Insufficient "+at.attr("placeholder")+"..."}function c(ar,au,at){this.concepto=ar;this.cantidad=au;this.precio=at}function ab(){var ar;if(j.val()){if((af.val())&&(!isNaN(af.val()))&&(af.val()>0)){if((k.val())&&(!isNaN(k.val()))&&(k.val()>0)){ar=new c(j.val(),af.val(),k.val());b.push(ar);B.innerHTML="<span><b style='font'>"+j.val()+"</b></span>";j.val("");af.val("");k.val("");return true}else{a(k,B);return false}}else{a(af,B);return false}}else{a(j,B);return false}}function S(){var av,at,ar={},au={NAME:n.text(),VERSION:1};ar.titulo=n.text();ar.name=Q.text()+ar.titulo.substring(0,1);ar.fecha=C.text();if(ab()){for(av in b){if(b.hasOwnProperty(av)){at="concepto"+av;ar[at]=b[av]}}openDB.odb.open(au,ar,ae,"add");D.popup("close");u(ar.titulo)}b=[]}var o=function(at){var av,ar,au;$("#logo").hide();w.addClass("datos");if(typeof at=="string"&&z.length<1){$("#textologo").empty();e.text("Please add new client.");$("<div>").append("<p class='margen' style='color: red;'>There are no clients in the database, please write them.</p>").appendTo("#textologo");$("#logo").show();w.removeClass("datos")}else{if(typeof at!="string"){z.push(at);ar=at[A[1]].split(".",1).toString();$("<li>").append("<a href='#' id="+ar+"><h3><span>"+at[A[1]]+"</span></h3><p><span>"+at[A[0]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+at[A[2]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+at[A[3]]+"</span></p></a>").appendTo(w);av="#"+ar;$(av).click(function(aw){aw.stopPropagation();ai.empty();for(au in at){if(at.hasOwnProperty(au)){if(at[au]){if(au==="cif"){$("<li>").append("<a href='#' class='color' id="+au+">"+at[au]+"</a>").appendTo(ai)}else{if(au==="name"){$("<li>").append("<a href='#' class='color' id="+au+">"+at[au]+"</a>").appendTo(ai)}else{$("<li class='color'>").append("<span>"+at[au]+"</span>").appendTo(ai)}}}}}$("#cif").click(function(ax){u(at[A[1]])});$("#name").click(function(ax){ad.text(at.name);ak(at)});ai.listview("refresh");v.panel("open")});w.listview("refresh")}}};function Z(){al.text("Thoomic");ad.text("New Client");w.empty();R.focus();e.text("Customer database, add new clients.");z=[];openDB.odb.open(U,"",o,"read")}function aj(at){var ar,au;ar=JSON.parse(at);if(ar){for(au in ar){if(ar.hasOwnProperty(au)){openDB.odb.open(U,ar[au],ae,"add")}}Z()}}function h(au){var at,ar;$("#readfile").popup("close");at=au.target.files[0];if(at){ar=new FileReader();ar.onload=function(aw){var av=aw.target.result;aj(av)};ar.readAsText(at);$("#selectfile").val("")}}function x(){var ax,aw={},au=$("#id_cif"),av=$("#id_nombre"),ar=$("#id_telefono"),at=$("#id_email");if(/^(\+\d{2,3}\s)*\d{9,10}$/.test(ar.val())){aw.telefono=ar.val()}else{a(ar,K)}if(av.val()){aw.name=av.val()}else{a(av,K)}if(/^\w+$/.test(au.val())){aw.cif=au.val()}else{a(au,K)}if(/^(([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4}))*$/.test(at.val())){aw.email=at.val()}else{a(at,K);aw.telefono=""}if(aw.name&&aw.cif&&aw.telefono){switch(ad.text()){case"Invoice Issuer":for(ax in aw){if(aw.hasOwnProperty(ax)){localStorage.setItem(ax,aw[ax]);ae(aw[ax])}}ak(aw);ae("Data saved from the invoice issuer!!");break;case"New Client":openDB.odb.open(U,aw,ae,"add");Z();break;default:openDB.odb.open(U,aw,ae,"update");Z()}s.popup("close")}}function V(){var ar={};ar.name=$("#update").text();if(/\w*/.test(ag.val())){ar.domicilio=ag.val()}else{a(ag)}if(/\w*/.test(F.val())){ar.cp=F.val()}else{a(F)}if(/\w*/.test(ap.val())){ar.poblacion=ap.val()}else{a(ap)}if(/\w*/.test(r.val())){ar.pais=r.val()}else{a(r)}H.popup("close");if(al.text()==="Thoomic"){openDB.odb.open(U,ar,ae,"update");Z()}else{localStorage.setItem("domicilio",ar.domicilio);localStorage.setItem("cp",ar.cp);localStorage.setItem("poblacion",ar.poblacion);localStorage.setItem("pais",ar.pais);an()}}function Y(){var av,at="ThoomicDB.json",ar,ax,au=$("#name"),ay={};switch(M.text()){case"Export...":try{ar=new Blob([JSON.stringify(z)],{type:"application/json"});saveAs(ar,at);ae("ThoomicDB.json file is saved.")}catch(aw){ae("Error: ThoomicDB.json is not saved. "+aw.message)}break;case"Deleting...":av=au.text();openDB.odb.open(U,av,ae,"delete");ay={NAME:av,VERSION:1};openDB.odb.open(ay,null,ae,"deleteDB");Z();break;default:ay={NAME:al.text(),VERSION:1};ax=t.text();av=al.text();openDB.odb.open(ay,ax,ae,"delete");w.empty();openDB.odb.open(ay,av,ah,"read")}}function N(ar){switch(ar.keyCode){case 17:an();break;case 220:an();break;case 13:Z();break;case 107:i();break;default:}R.value=""}function G(){var ax=$("#reload"),ay=$("#id_nuevo_cliente"),au=$("#import"),ar=$("#export"),aA=$("#menu"),az=$("#btn_popup_delete"),av=$("#bsave"),aw=$("#btn_save_bill"),at=$("#btn_next_bill");R.addEventListener("keyup",N,true);document.getElementById("selectfile").addEventListener("change",h,false);document.getElementById("nuevo_cliente").addEventListener("keydown",function(aB){if(aB.keyCode===13){x()}});document.getElementById("nuevo_cliente").addEventListener("keydown",function(aB){if(aB.keyCode===27){H.popup("close")}});document.getElementById("address").addEventListener("keydown",function(aB){if(aB.keyCode===13){V()}});document.getElementById("address").addEventListener("keydown",function(aB){if(aB.keyCode===27){s.popup("close")}});av.click(function(){V()});ax.click(function(){if(L){clearTimeout(L)}Z()});au.click(function(){e.text("Imports the customer data file.")});ar.click(function(){e.text("Exports customer database.");m()});ay.click(function(){i()});ay.hover(function(){if(al.text()==="Thoomic"){e.text("Add Client")}else{e.text("Add Invoice")}});g.click(function(){x()});t.click(function(){J()});aw.click(function(){S()});at.click(function(){ab()});az.click(function(){Y()});aA.click(function(){an()})}G();E();L=setTimeout(Z,6000)};