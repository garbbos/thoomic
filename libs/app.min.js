window.onload=function(){var W={NAME:"ThoomicDB",VERSION:1},B=["cif","name","telefono","email"],aj=$("#domicilio"),G=$("#cp"),ar=$("#poblacion"),r=$("#pais"),b=[],A=[],J=[],ac=true,N,V=document.getElementById("form_datos"),ai=document.getElementById("currency"),v=$("#panel"),t=$("#deleteID"),s=$("#nuevo_cliente"),R=$("#popup_delete"),I=$("#address"),O=$("#deltitulo"),an=$("#panel_titulo"),w=$("#lista"),ak=$("#datapanel"),E=$("#nuevobill"),g=$("#btn_save"),K=document.getElementById("jogo"),ao=document.getElementById("txjogo"),T=document.getElementById("myFilter"),at=$("#form_bill"),o=$("#titulobill"),S=$("#numerobill"),D=$("#fechabill"),j=$("#concepto"),ah=$("#cantidad"),k=$("#precio"),Q=$("#status"),q=$("#msg"),e=$("#rotulo"),aq=$("#principal"),C=document.getElementById("texto_concepto"),M=document.getElementById("texto_new"),af=$("#titulo_nuevo");function ag(au){if(au){q.text(au);Q.animate({opacity:"1"});setTimeout(function(){Q.animate({opacity:"0"})},3000);window.console.log(au)}}function f(){var au,av={};for(au in B){if(B.hasOwnProperty(au)){av[B[au]]=localStorage.getItem(B[au])}}av.domicilio=localStorage.getItem("domicilio");av.cp=localStorage.getItem("cp");av.poblacion=localStorage.getItem("poblacion");av.pais=localStorage.getItem("pais");return av}function F(){var au=f();if(!au[1]){e.text("Please, enter your data as an invoice issuer.")}else{e.text("Button menu for details: "+au[1])}}function d(){var aw=new Date(),ax,au,av;ax=aw.getDate();au=aw.getMonth();au=au+1;av=aw.getFullYear();aw=(ax+"/"+au+"/"+av);return aw}function Z(av){var au;if(av){for(au=0;au<av.elements.length;au++){av.elements[au].value="";av.elements[au].style.background="#FFFFFF"}M.innerHTML=""}}function m(au){var av=parseInt(localStorage.getItem(au),10);if(av){av=av+1}else{av=1}localStorage.setItem(au,av);return av}function z(av,au){var aw;if(av){v.panel("close");Z(V);af.text(au);for(aw in B){if(B.hasOwnProperty(aw)){if(av[B[aw]]){V.elements[aw].value=av[B[aw]]}}}s.popup("open",{positionTo:"window",transition:"pop"})}}function Y(){var au;o.text(an.text());au="000000"+m(o.text());S.text(au);D.text(d());j.val("");ah.val("");k.val("");C.innerHTML="";E.popup();E.popup("open",{positionTo:"window",transition:"pop"})}function p(){v.panel("close");w.empty();w.removeClass("datos");$("#textologo").empty();$("hori").empty();clearTimeout(N)}function am(au){var aw,av=$("#textologo");p();if(au.name){if(an.text()==="Thoomic"){$("<a href='#' class='ui-btn ui-btn-inline ui-icon-grid ui-btn-icon-left ui-mini ui-corner-all color' id='bill'>").append("toBill").appendTo(av);$("#bill").click(function(){u(au.name)})}else{au.domicilio=localStorage.getItem("domicilio");au.cp=localStorage.getItem("cp");au.poblacion=localStorage.getItem("poblacion");au.pais=localStorage.getItem("pais")}$("<a href='#' class='ui-btn ui-btn-inline ui-icon-gear ui-btn-icon-left ui-mini ui-corner-all' id='up'>").append((au.name||"Your company")).appendTo(av);$("<div>").append("<span>&nbsp;&nbsp;&nbsp;"+(au.cif||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(au.telefono||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(au.email||"")+"</span><p>").appendTo(av);$("<div class='margen'>").append("<a href='#' id='loc' data-mini='true' class='ui-btn ui-mini ui-icon-home ui-btn-icon-left ui-btn-inline ui-corner-all'>Location</a>").appendTo(av);$("<div>").append("</span><span>&nbsp;&nbsp;&nbsp;"+(au.domicilio||"")).appendTo(av);$("<div>").append("</span><span>&nbsp;&nbsp;&nbsp;"+(au.cp||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(au.poblacion||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(au.pais||"")+"</span><p>").appendTo(av);$("#update").text(au.name);$("#up").click(function(){z(au)});$("#loc").click(function(){aj.val(au.domicilio);G.val(au.cp);ar.val(au.poblacion);r.val(au.pais);I.popup("open",{positionTo:"window",transition:"pop"})});$("#logo").show()}else{e.text("Add details of your company.")}}var x=function(av){var aw,ax,au;$("#logo").hide();w.addClass("datos");if(typeof av==="string"&&A.length<1){$("#textologo").empty();e.text("Please add new client.");$("<div>").append("<p class='margen' style='color: red;'>There are no clients in the database, please write them.</p>").appendTo("#textologo");$("#logo").show();w.removeClass("datos")}else{if(typeof av!=="string"){A.push(av);au=av[B[1]].split(".",1).toString();$("<li>").append("<a href='#' id="+au+"><h3><span>"+av[B[1]]+"</span></h3><p><span>"+av[B[0]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+av[B[2]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+av[B[3]]+"</span></p></a>").appendTo(w);ax="#"+au;$(ax).click(function(ay){ay.stopPropagation();ak.empty();$("#currency option:selected").text(localStorage.getItem("currency")).change();for(aw in av){if(av.hasOwnProperty(aw)){if(av[aw]){if(aw==="cif"){$("<li>").append("<a href='#' class='color ui-mini' id="+aw+">"+av[aw]+"</a>").appendTo(ak)}else{if(aw==="name"){$("<li>").append("<a href='#' class='color ui-mini' id="+aw+">"+av[aw]+"</a>").appendTo(ak)}else{$("<li class='color ui-mini'>").append("<span>"+av[aw]+"</span>").appendTo(ak)}}}}}$("#cif").click(function(az){u(av[B[1]])});$("#name").click(function(az){af.text(av.name);am(av)});$("#clave").text(av.name);ak.listview("refresh");v.panel("open")});w.listview("refresh")}}};function ab(){clearTimeout(N);an.text("Thoomic");t.text("Delete");af.text("New Client");w.empty();$("#money").show();T.focus();e.text("Customer database, add new clients.");A=[];openDB.odb.open(W,"",x,"read")}function i(){Z(V);if(an.text()==="Thoomic"){ab();af.text("New Client");e.text("Add customer data.");s.popup("open",{positionTo:"window",transition:"pop"})}else{Y()}}function ap(){var au;w.removeClass("datos");clearTimeout(N);Z(V);e.text("Complete your company details.");af.text("Invoice Issuer");au=f();an.text(au.name);am(au);if(!au.name){s.popup("open",{positionTo:"window",transition:"pop"})}}function n(){v.panel("close");if(A[0]){O.text("Export...")}else{O.text("There is no customer data...")}R.popup("open",{positionTo:"window",transition:"pop"})}function L(){v.panel("close");R.popup("open",{positionTo:"window",transition:"pop"})}function ae(ax){var aA,ay,az=(localStorage.getItem("tax")||21),au=[],aw=document.getElementById("#form_update"),av=$("#tax");if((typeof ax==="string")&&(J.length<1)){w.removeClass("datos");$("#textologo").empty();$("#hori").empty();$("<div>").append("<p class='margen' style='color: red;'>There are no invoices in the database, please write them.</p>").appendTo("#textologo");$("#logo").show();i()}else{$("#money").hide();if(typeof ax!=="string"){$("<li>").append("<a href='#' id="+ax.name+"><h3>"+ax.titulo+"</h3><p>Date: "+ax.fecha+"&nbsp;&nbsp;&nbsp;&nbsp;Bill NÂº: "+ax.name+"&nbsp;&nbsp;&nbsp;&nbsp;</p></a>").appendTo(w);J.push(ax);o.text(ax.titulo);$("#clave").text(ax.name);aA="#"+ax.name;w.listview("refresh");$(aA).click(function(aC){var aB,aD;aC.stopPropagation();ak.empty();MYPDF.init();for(aD in ax){if(ax.hasOwnProperty(aD)){switch(aD){case"titulo":openDB.odb.open(W,ax[aD],MYPDF.client,"get");o.text(ax[aD]);break;case"name":$("<li>").append("<a href='#' class='color ui-mini' id='name'>No. "+ax[aD]+"</a>").appendTo(ak);$("#clave").text(ax[aD]);break;case"fecha":$("<li class='color ui-mini'>").append("<span>"+ax[aD]+"</span>").appendTo(ak);break;default:if(ax[aD].cantidad){$("<li class='color ui-mini'>").append("<span>"+ax[aD].cantidad+"</span><span><b>&nbsp;"+ax[aD].concepto+"</b></span>").appendTo(ak);$("<li class='color ui-mini'>").append("<span>Unit: "+ax[aD].precio+" "+ax.currency+"</span><span>&nbsp;&nbsp;&nbsp;Subtotal: "+(ax[aD].cantidad*ax[aD].precio)+" "+ax.currency+"</span>").appendTo(ak);MYPDF.bill(ax[aD].concepto,ax[aD].cantidad,ax[aD].precio)}}}}$("#btn_generating").click(function(aE){if(av.val()<0){az=21}else{az=av.val()}localStorage.setItem("tax",az);MYPDF.invoice(ax);MYPDF.tax(az);MYPDF.save($("#comments").val());ay={NAME:ax.name,VERSION:1};openDB.odb.open(ay,ax,ag,"update");$("#genpdf").popup("close")});$("#name").click(function(aE){v.panel("close");av.val(az);au=f();if(au.name){MYPDF.setup(au);$("#comments").val("");$("#genpdf").popup("open",{positionTo:"window",transition:"pop"})}else{ag("Setup is empty, write it!!")}});ak.listview("refresh");t.text(ax.name);v.panel("open")})}}}function u(au){v.panel("close");w.empty();w.addClass("datos");if(au){e.text("Invoice to: "+au);var av={NAME:au,VERSION:1};openDB.odb.open(av,null,ae,"read");an.text(au);J=[]}$("#logo").hide()}function a(av,au){av.css("background-color","#ffcc66").trigger("create");av.on("focusin",function(){av.css("background-color","#ffffff").trigger("create")});au.innerHTML="Insufficient "+av.attr("placeholder")+"..."}function c(au,aw,av){this.concepto=au;this.cantidad=aw;this.precio=av}function ad(){var au;if(j.val()){if((ah.val())&&(!isNaN(ah.val()))&&(ah.val()>0)){if((k.val())&&(!isNaN(k.val()))&&(k.val()>0)){au=new c(j.val(),ah.val(),k.val());b.push(au);C.innerHTML="<span><b style='font'>"+j.val()+"</b></span>";j.val("");ah.val("");k.val("");return true}else{a(k,C);return false}}else{a(ah,C);return false}}else{a(j,C);return false}}function U(){var ax,av,au={},aw={NAME:o.text(),VERSION:1};au.titulo=o.text();au.name=S.text()+au.titulo.substring(0,1);au.fecha=D.text();au.currency=localStorage.getItem("currency");if(ad()){for(ax in b){if(b.hasOwnProperty(ax)){av="concepto"+ax;au[av]=b[ax]}}openDB.odb.open(aw,au,ag,"add");E.popup("close");u(au.titulo)}b=[]}function al(av){var au,aw;au=JSON.parse(av);if(au){for(aw in au){if(au.hasOwnProperty(aw)){openDB.odb.open(W,au[aw],ag,"add")}}ab()}}function h(aw){var av,au;$("#readfile").popup("close");av=aw.target.files[0];if(av){au=new FileReader();au.onload=function(ay){var ax=ay.target.result;al(ax)};au.readAsText(av);$("#selectfile").val("")}}function y(){var az,ay={},aw=$("#id_cif"),ax=$("#id_nombre"),au=$("#id_telefono"),av=$("#id_email");if(/^(\+\d{2,3}\s)*\d{9,10}$/.test(au.val())){ay.telefono=au.val()}else{a(au,M)}if(ax.val()){ay.name=ax.val()}else{a(ax,M)}if(/^\w+$/.test(aw.val())){ay.cif=aw.val()}else{a(aw,M)}if(/^(([ a-zA-Z0-9_\.\- ])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4}))*$/.test(av.val())){ay.email=av.val()}else{a(av,M);ay.telefono=""}if(ay.name&&ay.cif&&ay.telefono){switch(af.text()){case"Invoice Issuer":for(az in ay){if(ay.hasOwnProperty(az)){localStorage.setItem(az,ay[az])}}am(ay);ag("Data saved from the invoice issuer!!");break;case"New Client":openDB.odb.open(W,ay,ag,"add");ab();break;default:openDB.odb.open(W,ay,ag,"update");ab()}s.popup("close")}}function X(){var au={};au.name=$("#update").text();if(/\w*/.test(aj.val())){au.domicilio=aj.val()}else{a(aj)}if(/\w*/.test(G.val())){au.cp=G.val()}else{a(G)}if(/\w*/.test(ar.val())){au.poblacion=ar.val()}else{a(ar)}if(/\w*/.test(r.val())){au.pais=r.val()}else{a(r)}I.popup("close");if(an.text()==="Thoomic"){openDB.odb.open(W,au,ag,"update");ab()}else{localStorage.setItem("domicilio",au.domicilio);localStorage.setItem("cp",au.cp);localStorage.setItem("poblacion",au.poblacion);localStorage.setItem("pais",au.pais);ap()}}function aa(){var ax,av="ThoomicDB.json",au,az,aw=$("#name"),aA={};switch(O.text()){case"Export...":try{au=new Blob([JSON.stringify(A)],{type:"application/json"});saveAs(au,av);ag("ThoomicDB.json file is saved.")}catch(ay){ag("Error: ThoomicDB.json is not saved. "+ay.message)}break;case"Deleting...":if(an.text()==="Thoomic"){ax=aw.text();openDB.odb.open(W,ax,ag,"delete");aA={NAME:ax,VERSION:1};openDB.odb.open(aA,null,ag,"deleteDB");ab()}else{az=$("#clave").text();ax=an.text();aA={NAME:ax,VERSION:1};openDB.odb.open(aA,az,ag,"delete");u(ax)}break;default:}}function l(au){localStorage.setItem("currency",$("#currency option:selected").text())}function P(au){switch(au.keyCode){case 17:ap();break;case 220:ap();break;case 13:ab();break;case 107:i();break;default:}T.value=""}function H(){var ax=$("#reload"),az=$("#id_nuevo_cliente"),ay=$("#export"),aw=$("#menu"),av=$("#btn_popup_delete"),aB=$("#bsave"),au=$("#btn_save_bill"),aA=$("#btn_next_bill");aB.click(function(){X()});ax.click(function(){ab()});ay.click(function(){e.text("Exports customer database.");n()});az.click(function(){i()});g.click(function(){y()});t.click(function(){L()});au.click(function(){U()});aA.click(function(){ad()});av.click(function(){aa()});aw.click(function(){ap()});T.addEventListener("keyup",P,true);ai.addEventListener("change",l,false);document.getElementById("selectfile").addEventListener("change",h,false);document.getElementById("nuevo_cliente").addEventListener("keyup",function(aC){switch(aC.keyCode){case 13:y();break;case 27:s.popup("close");break;default:}});document.getElementById("address").addEventListener("keyup",function(aC){switch(aC.keyCode){case 13:X();break;case 27:I.popup("close");break;default:}})}N=setTimeout(ab,4000);H();F()};