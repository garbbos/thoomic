window.onload=function(){var T={NAME:"ThoomicDB",VERSION:1},z=["cif","name","telefono","email"],ag=$("#domicilio"),E=$("#cp"),an=$("#poblacion"),p=$("#pais"),b=[],y=[],H=[],K,S=document.getElementById("form_datos"),af=document.getElementById("currency"),t=$("#panel"),r=$("#deleteID"),q=$("#nuevo_cliente"),O=$("#popup_delete"),G=$("#address"),L=$("#deltitulo"),ak=$("#panel_titulo"),u=$("#lista"),ah=$("#datapanel"),C=$("#nuevobill"),Q=document.getElementById("myFilter"),ao=$("#form_bill"),n=$("#titulobill"),P=$("#numerobill"),A=$("#fechabill"),i=$("#concepto"),ae=$("#cantidad"),j=$("#precio"),N=$("#status"),e=$("#rotulo"),am=$("#principal"),B=document.getElementById("texto_concepto"),J=document.getElementById("texto_new"),ab=$("#titulo_nuevo");function ac(ap){if(ap){$("#msg").text(ap);N.animate({opacity:"1"});setTimeout(function(){N.animate({opacity:"0"})},3000);window.console.log(ap)}}function f(){var ap,aq={};for(ap in z){if(z.hasOwnProperty(ap)){aq[z[ap]]=localStorage.getItem(z[ap])}}aq.domicilio=localStorage.getItem("domicilio");aq.cp=localStorage.getItem("cp");aq.poblacion=localStorage.getItem("poblacion");aq.pais=localStorage.getItem("pais");return aq}function D(){var ap=f();if(!ap[1]){e.text("Please, enter the data of the invoice issuer.")}else{e.text("Button menu for details: "+ap[1])}}function d(){var ar=new Date(),at,ap,aq;at=ar.getDate();ap=ar.getMonth();ap=ap+1;aq=ar.getFullYear();ar=(at+"/"+ap+"/"+aq);return ar}function W(aq){var ap;if(aq){for(ap=0;ap<aq.elements.length;ap++){aq.elements[ap].value="";aq.elements[ap].style.background="#FFFFFF"}J.innerHTML=""}}function l(ap){var aq=parseInt(localStorage.getItem(ap),10);if(aq){aq=aq+1}else{aq=1}localStorage.setItem(ap,aq);return aq}function x(aq,ap){var ar;if(aq){t.panel("close");W(S);ab.text(ap);for(ar in z){if(z.hasOwnProperty(ar)){if(aq[z[ar]]){S.elements[ar].value=aq[z[ar]]}}}q.popup("open",{positionTo:"window",transition:"pop"})}}function V(){var ap;n.text(ak.text());ap="000000"+l(n.text());P.text(ap);A.text(d());i.val("");ae.val("");j.val("");B.innerHTML="";C.popup();C.popup("open",{positionTo:"window",transition:"pop"})}function o(){if(K){clearTimeout(K)}u.empty();u.removeClass("datos");$("#textologo").empty()}function aj(ap){var aq=$("#textologo");t.panel("close");o();if(ap.name){if(ak.text()==="Thoomic"){$("<a href='#' class='ui-btn ui-btn-inline ui-icon-grid ui-btn-icon-left ui-mini ui-corner-all color' id='bill'>").append("toBill").appendTo(aq);$("#bill").click(function(){s(ap.name)})}else{ap.domicilio=localStorage.getItem("domicilio");ap.cp=localStorage.getItem("cp");ap.poblacion=localStorage.getItem("poblacion");ap.pais=localStorage.getItem("pais")}$("<a href='#' class='ui-btn ui-btn-inline ui-icon-gear ui-btn-icon-left ui-mini ui-corner-all' id='up'>").append((ap.name||"Your company")).appendTo(aq);$("<div>").append("<span>&nbsp;&nbsp;&nbsp;"+(ap.cif||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(ap.telefono||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(ap.email||"")+"</span><p>").appendTo(aq);$("<div class='margen'>").append("<a href='#' id='loc' data-mini='true' class='ui-btn ui-mini ui-icon-home ui-btn-icon-left ui-btn-inline ui-corner-all'>Location</a>").appendTo(aq);$("<div>").append("</span><span>&nbsp;&nbsp;&nbsp;"+(ap.domicilio||"")).appendTo(aq);$("<div>").append("</span><span>&nbsp;&nbsp;&nbsp;"+(ap.cp||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(ap.poblacion||"")+"</span><span>&nbsp;&nbsp;&nbsp;"+(ap.pais||"")+"</span><p>").appendTo(aq);$("#update").text(ap.name);$("#up").click(function(){x(ap)});$("#loc").click(function(){ag.val(ap.domicilio);E.val(ap.cp);an.val(ap.poblacion);p.val(ap.pais);G.popup("open",{positionTo:"window",transition:"pop"})});$("#logo").show()}else{e.text("Add details of your company.")}}var v=function(aq){var ar,at,ap;$("#logo").hide();u.addClass("datos");if(typeof aq==="string"&&y.length<1){$("#textologo").empty();e.text("Please add new client.");$("<div>").append("<p class='margen' style='color: red;'>There are no clients in the database, please write them.</p>").appendTo("#textologo");$("#logo").show();u.removeClass("datos")}else{if(typeof aq!=="string"){y.push(aq);ap=aq[z[1]].split(".",1).toString();$("<li>").append("<a href='#' id="+ap+"><h3><span>"+aq[z[1]]+"</span></h3><p><span>"+aq[z[0]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+aq[z[2]]+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;"+aq[z[3]]+"</span></p></a>").appendTo(u);at="#"+ap;$(at).click(function(au){au.stopPropagation();ah.empty();$("#currency option:selected").text((localStorage.getItem("currency")||"€")).change();for(ar in aq){if(aq.hasOwnProperty(ar)){if(ar==="cif"){$("<li>").append("<a href='#' class='color ui-mini' id="+ar+">"+(aq[ar]||"----")+"</a>").appendTo(ah)}else{if(ar==="name"){$("<li>").append("<a href='#' class='color ui-mini' id="+ar+">"+(aq[ar]||"----")+"</a>").appendTo(ah)}else{$("<li class='color ui-mini'>").append("<span>"+(aq[ar]||"----")+"</span>").appendTo(ah)}}}}$("#cif").click(function(av){s(aq[z[1]])});$("#name").click(function(av){ab.text(aq.name);aj(aq)});$("#clave").text(aq.name);ah.listview("refresh");t.panel("open")});u.listview("refresh")}}};function Y(){if(K){clearTimeout(K)}ak.text("Thoomic");r.text("Delete");ab.text("New Client");u.empty();$("#money").show();Q.focus();e.text("Add new clients.");y=[];openDB.odb.open(T,"",v,"read")}function h(){W(S);if(ak.text()==="Thoomic"){Y();ab.text("New Client");e.text("Add customer data.");q.popup("open",{positionTo:"window",transition:"pop"})}else{V()}}function al(){var ap;u.removeClass("datos");clearTimeout(K);W(S);e.text("Complete your company details.");ab.text("Invoice Issuer");ap=f();ak.text(ap.name);if(ap.name){aj(ap)}else{q.popup("open",{positionTo:"window",transition:"pop"})}}function ad(ap){if(typeof ap==="string"){m()}else{y.push(ap)}}function m(){var aq="ThoomicDB.json",ap;if(y.length>0){e.text("Exporting "+y.length+" clients from your database.");try{ap=new Blob([JSON.stringify(y)],{type:"application/json"});saveAs(ap,aq);ac("ThoomicDB.json file is saved.")}catch(ar){ac("Error: ThoomicDB.json is not saved. "+ar.message)}}else{ac("No customer data... to export.")}}function I(){t.panel("close");O.popup("open",{positionTo:"window",transition:"pop"})}function aa(ar){var av,at,au=(localStorage.getItem("tax")||21),ap={},aq=$("#tax");if(typeof ar!=="string"){$("<li>").append("<a href='#' id="+ar.name+"><h3>"+ar.titulo+"</h3><p>Date: "+ar.fecha+"&nbsp;&nbsp;&nbsp;&nbsp;Bill Nº: "+ar.name+"&nbsp;&nbsp;&nbsp;&nbsp; "+ar.concepto0.concepto+"</p></a>").appendTo(u);H.push(ar);n.text(ar.titulo);$("#clave").text(ar.name);av="#"+ar.name;$(av).click(function(aw){var ax;aw.stopPropagation();ah.empty();MYPDF.init();for(ax in ar){if(ar.hasOwnProperty(ax)){switch(ax){case"titulo":openDB.odb.open(T,ar[ax],MYPDF.client,"get");n.text(ar[ax]);break;case"name":$("<li>").append("<a href='#' class='color ui-mini' id='name'>No. "+ar[ax]+"</a>").appendTo(ah);$("#clave").text(ar[ax]);break;case"fecha":$("<li class='color ui-mini'>").append("<span>"+ar[ax]+"</span>").appendTo(ah);break;default:if(ar[ax].cantidad){$("<li class='color ui-mini'>").append("<span>"+ar[ax].cantidad+"</span><span><b>&nbsp;"+ar[ax].concepto+"</b></span>").appendTo(ah);$("<li class='color ui-mini'>").append("<span>Unit: "+ar[ax].precio+" "+ar.currency+"</span><span>&nbsp;&nbsp;&nbsp;Subtotal: "+(ar[ax].cantidad*ar[ax].precio)+" "+ar.currency+"</span>").appendTo(ah);MYPDF.bill(ar[ax].concepto,ar[ax].cantidad,ar[ax].precio)}}}}$("#btn_generating").click(function(ay){if(aq.val()<0){au=21}else{au=aq.val()}localStorage.setItem("tax",au);MYPDF.invoice(ar);MYPDF.tax(au);MYPDF.save($("#comments").val());at={NAME:ar.name,VERSION:1};openDB.odb.open(at,ar,ac,"update");$("#genpdf").popup("close")});$("#name").click(function(ay){t.panel("close");aq.val(au);ap=f();if(ap.name){MYPDF.setup(ap);$("#comments").val("");$("#genpdf").popup("open",{positionTo:"window",transition:"pop"})}else{ac("The data of the invoice issuer is empty, write it!!")}});ah.listview("refresh");r.text(ar.name);t.panel("open")});u.listview("refresh")}else{if(H.length===0){u.removeClass("datos");$("#textologo").empty();$("<div>").append("<p class='margen' style='color: red;'>There are no invoices in the database, please write them.</p>").appendTo("#textologo");$("#logo").show();h()}}}function s(ap){t.panel("close");u.empty();u.addClass("datos");if(ap){e.text("Invoice to: "+ap);var aq={NAME:ap,VERSION:1};openDB.odb.open(aq,null,aa,"read");ak.text(ap);H=[]}$("#logo").hide()}function a(aq,ap){aq.css("background-color","#ffcc66").trigger("create");aq.on("focusin",function(){aq.css("background-color","#ffffff").trigger("create")});ap.innerHTML="Insufficient "+aq.attr("placeholder")+"..."}function c(ap,ar,aq){this.concepto=ap;this.cantidad=ar;this.precio=aq}function Z(){var ap;if(i.val()){if((ae.val())&&(!isNaN(ae.val()))&&(ae.val()>0)){if((j.val())&&(!isNaN(j.val()))&&(j.val()>0)){ap=new c(i.val(),ae.val(),j.val());b.push(ap);B.innerHTML="<span><b style='font'>"+i.val()+"</b></span>";i.val("");ae.val("");j.val("");return true}else{a(j,B);return false}}else{a(ae,B);return false}}else{a(i,B);return false}}function R(){var at,aq,ap={},ar={NAME:n.text(),VERSION:1};ap.titulo=n.text();ap.name=P.text()+ap.titulo.substring(0,1);ap.fecha=A.text();ap.currency=localStorage.getItem("currency");if(Z()){for(at in b){if(b.hasOwnProperty(at)){aq="concepto"+at;ap[aq]=b[at]}}openDB.odb.open(ar,ap,ac,"add");C.popup("close");s(ap.titulo)}b=[]}function ai(aq){var ap,ar;if(aq){ap=JSON.parse(aq);if(ap){for(ar in ap){if(ap.hasOwnProperty(ar)){openDB.odb.open(T,ap[ar],ac,"add")}}Y()}}}function g(ar){var aq,ap;$("#readfile").popup("close");aq=ar.target.files[0];if(aq){ap=new FileReader();ap.onload=function(au){var at=au.target.result;ai(at)};ap.readAsText(aq);$("#selectfile").val("")}}function w(){var av,au={},ar=$("#id_cif"),at=$("#id_nombre"),ap=$("#id_telefono"),aq=$("#id_email");if(/^(\+\d{2,3}\s)*\d{9,10}$/.test(ap.val())){au.telefono=ap.val()}else{a(ap,J)}if(at.val()){au.name=at.val()}else{a(at,J)}if(/^\w+$/.test(ar.val())){au.cif=ar.val()}else{a(ar,J)}if(/^(([ a-zA-Z0-9_\.\- ])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4}))*$/.test(aq.val())){au.email=aq.val()}else{a(aq,J);au.telefono=""}if(au.name&&au.cif&&au.telefono){switch(ab.text()){case"Invoice Issuer":for(av in au){if(au.hasOwnProperty(av)){localStorage.setItem(av,au[av])}}aj(au);ac("Data saved from the invoice issuer!!");break;case"New Client":openDB.odb.open(T,au,ac,"add");Y();break;default:openDB.odb.open(T,au,ac,"update");Y()}q.popup("close")}}function U(){var ap={};ap.name=$("#update").text();if(/\w*/.test(ag.val())){ap.domicilio=ag.val()}else{a(ag)}if(/\w*/.test(E.val())){ap.cp=E.val()}else{a(E)}if(/\w*/.test(an.val())){ap.poblacion=an.val()}else{a(an)}if(/\w*/.test(p.val())){ap.pais=p.val()}else{a(p)}G.popup("close");if(ak.text()==="Thoomic"){openDB.odb.open(T,ap,ac,"update");Y()}else{localStorage.setItem("domicilio",ap.domicilio);localStorage.setItem("cp",ap.cp);localStorage.setItem("poblacion",ap.poblacion);localStorage.setItem("pais",ap.pais);al()}}function X(){var aq,ar,ap=$("#name"),at={};if(ak.text()==="Thoomic"){aq=ap.text();openDB.odb.open(T,aq,ac,"delete");at={NAME:aq,VERSION:1};openDB.odb.open(at,null,ac,"deleteDB");Y()}else{ar=$("#clave").text();aq=ak.text();at={NAME:aq,VERSION:1};openDB.odb.open(at,ar,ac,"delete");s(aq)}}function k(ap){localStorage.setItem("currency",$("#currency option:selected").text())}function M(ap){switch(ap.keyCode){case 17:al();break;case 220:al();break;case 13:Y();break;case 107:h();break;default:}Q.value=""}function F(){var au=$("#reload"),aw=$("#id_nuevo_cliente"),ap=$("#export"),ay=$("#menu"),ax=$("#btn_popup_delete"),ar=$("#bsave"),av=$("#btn_save"),at=$("#btn_save_bill"),aq=$("#btn_next_bill");ar.click(function(){U()});au.click(function(){Y()});au.hover(function(){e.text("Reload customer database.")});au.focus(function(){e.text("Reload customer database.")});ap.click(function(){openDB.odb.open(T,"",ad,"read")});ap.hover(function(){e.text("Export your customer database to json file.")});ap.focus(function(){e.text("Export your customer database to json file.")});aw.click(function(){h()});av.click(function(){w()});r.click(function(){I()});$("#imfile").hover(function(){e.text("Import customer database.")});$("#imfile").focus(function(){e.text("Import customer database.")});at.click(function(){R()});aq.click(function(){Z()});ax.click(function(){X()});ay.click(function(){al()});ay.focus(function(){e.text("Write your data.")});ay.hover(function(){e.text("Write your data.")});Q.addEventListener("keyup",M,true);af.addEventListener("change",k,false);document.getElementById("selectfile").addEventListener("change",g,false);document.getElementById("nuevo_cliente").addEventListener("keyup",function(az){switch(az.keyCode){case 13:w();break;case 27:q.popup("close");break;default:}});document.getElementById("nuevobill").addEventListener("keyup",function(az){switch(az.keyCode){case 13:R();break;case 27:C.popup("close");break;default:}});document.getElementById("address").addEventListener("keyup",function(az){switch(az.keyCode){case 13:U();break;case 27:G.popup("close");break;default:}})}K=setTimeout(Y,4000);F();D();$("#app").height(screen.availHeight-100)};